name: Daily Fuel Prices Snapshot

on:
  schedule:
    # Runs once every day at 09:00 AEST (23:00 UTC previous day)
    - cron: '0 23 * * *'
  workflow_dispatch:

permissions:
  contents: write    # allow writing files back to the repo

jobs:
  fetch-save:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Fetch fuel price data
        env:
          FPD_TOKEN: ${{ secrets.FPD_API_TOKEN }}
        run: |
          timestamp=$(date -u +"%Y-%m-%dT%H-%M-%SZ")
          mkdir -p historical_data
          curl -H "Authorization: FPDAPI SubscriberToken=$FPD_TOKEN" \
               -H "Content-Type: application/json" \
               "https://fppdirectapi-prod.fuelpricesqld.com.au/Price/GetSitesPrices?countryId=21&geoRegionLevel=2&geoRegionId=16" \
               > historical_data/prices-$timestamp.json
          cp historical_data/prices-$timestamp.json historical_data/latest.json

      - name: Commit and push snapshot files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add historical_data/
          git commit -m "Add fuel prices snapshot $timestamp" || echo "No changes to commit"
          git push
