name: Update Turso Fuel DB (3 times a day)

on:
  schedule:
    # Runs at 9am, 2pm, 7pm AEST
    - cron: "5 4,9,23 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: fuel-db-update
  cancel-in-progress: false

jobs:
  run-update:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          # Added matplotlib and seaborn here
          pip install libsql requests pandas matplotlib seaborn
      - name: Write token files
        run: |
          printf "%s" "${{ secrets.FUEL_API_TOKEN }}" > fuel_api_token.txt
          printf "%s" "${{ secrets.TURSO_AUTH_TOKEN }}" > turso_token.txt

      - name: Check tokens are present
        env:
          FUEL_API_TOKEN: ${{ secrets.FUEL_API_TOKEN }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: |
          [ -n "$FUEL_API_TOKEN" ] || (echo "Missing FUEL_API_TOKEN secret" && exit 1)
          [ -n "$TURSO_AUTH_TOKEN" ] || (echo "Missing TURSO_AUTH_TOKEN secret" && exit 1)
          echo "Secrets present."

      # 1. Run the Data Update
      - name: Conduct API query and update Turso DB
        env:
          FUEL_API_TOKEN: ${{ secrets.FUEL_API_TOKEN }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: python query.py

      # 2. Run the Plot Generator (New Step)
      - name: Generate Plot
        env:
          # This script uses env vars, not the text files
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: python plots/plot_generator.py

      # 3. Commit JSON and SVG
      - name: Commit & Push changes
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          
          # Add the data JSON and the new SVG image
          git add data/latest.json plots/cheapest_fuel_30_days.svg
          
          git commit -m "Update fuel prices and plot [auto]" || echo "No changes to commit"
          git push
